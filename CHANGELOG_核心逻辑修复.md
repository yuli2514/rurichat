# 核心逻辑修复日志

## 修复时间
2026-02-22

## 修复内容

### 一、线上线下记忆系统统一

#### 核心改动
**线上和线下不再区分记忆存储，完全合并为统一的记忆系统。**

#### 修改文件
- [`api.js`](api.js:1708) - 线下总结重定向到统一记忆系统
- [`api.js`](api.js:1603) - 线下模式使用统一记忆
- [`components/memory-app.html`](components/memory-app.html:45) - 移除"线下总结"Tab
- [`apps.js`](apps.js:248) - 移除Tab切换逻辑

#### 修复内容
1. **废弃独立的线下总结存储**
   - `getOfflineSummaries()` 返回空数组
   - `addOfflineSummary()` 重定向到 `API.Memory.addMemory()`
   - `updateOfflineSummary()` 重定向到 `API.Memory.updateMemory()`
   - `deleteOfflineSummary()` 重定向到 `API.Memory.deleteMemory()`

2. **记忆App UI简化**
   - 移除"普通记忆"和"线下总结"两个Tab
   - 直接显示统一的记忆列表
   - 所有记忆（无论来自线上还是线下）都存储在同一个地方

3. **系统提示词更新**
   - 线下模式的记忆提示改为"包含线上和线下的所有记忆"
   - 移除对独立线下总结的引用

---

### 二、线下聊天提示词强制约束

#### 修改文件
- [`api.js`](api.js:1546)

#### 修复内容
在线下剧情模式的系统提示词中添加了严格的约束规则：

**新增的绝对禁区规则：**
1. ❌ **严禁替用户说话、抢话、行动或做任何决定**
   - 收起控制欲，只管好自己扮演的角色
   
2. ❌ **拒绝复读机**
   - 每次回复必须产出新内容推进剧情
   - 严禁照搬或改写之前用过的段落和句式

3. ✅ **只描写你扮演的角色**
   - 不要代替用户做任何事情

---

### 三、记忆App与自动总结重构

#### 核心改动：线上线下统一轮数计算

##### 1. 新增统一轮数计数器 ([`api.js`](api.js:1163))

**新增方法：**
- `_getUnifiedRoundCount(charId)` - 获取统一的轮数计数（线上+线下合并）
  - 返回：`{ totalRounds, onlineRounds, offlineRounds }`
  - **定义"1轮"：1次AI回复 = 1轮**（不按字数算）

- `_getLastSummaryRound(charId)` - 获取上次总结时的轮数

- `_setLastSummaryRound(charId, round)` - 设置上次总结时的轮数

- `_resetRoundCounter(charId)` - 重置轮数计数器
  - 在自动总结或手动总结后调用
  - 强制清零，重新从第1轮开始算

##### 2. 重构自动总结机制 ([`api.js`](api.js:1163))

**修改前：**
- 线上和线下分别计算消息数
- 使用历史长度作为触发条件
- 可能因消息数跳过倍数而永远不触发

**修改后：**
- 线上线下统一计算轮数（AI回复次数）
- 使用 `当前总轮数 - 上次总结轮数` 作为触发条件
- 自动总结后强制重置计数器
- 合并线上线下历史进行总结

##### 3. 线下模式自动总结统一 ([`api.js`](api.js:1668))

**修改前：**
- 线下模式单独计算消息数
- 生成独立的线下总结

**修改后：**
- 线下模式直接调用线上的 `checkAutoSummary`
- 使用统一的轮数计数器
- 线上线下共享同一套总结逻辑

##### 4. 手动总结重置机制 ([`apps.js`](apps.js:351))

**修改前：**
- 手动总结后不重置计数器
- 可能导致自动总结重复触发

**修改后：**
- 手动总结后强制调用 `API.Chat._resetRoundCounter()`
- 合并线上线下历史进行总结
- 确保手动总结后计数器清零

##### 5. 记忆App轮数显示 ([`components/memory-app.html`](components/memory-app.html:20))

**新增功能：**
- 在记忆App头部显示当前轮数：`轮数: X/Y`
  - X = 当前新增轮数（自上次总结以来）
  - Y = 自动总结频率设置
  
- 鼠标悬停显示详细信息：
  - 当前新增轮数
  - 线上轮数
  - 线下轮数
  - 自动总结频率

- 接近触发时颜色提示：
  - 当新增轮数 >= 频率 * 0.8 时，显示橙色加粗

**新增方法：** ([`apps.js`](apps.js:862))
- `updateRoundCount()` - 更新轮数显示
  - 在选择角色、渲染记忆时自动调用
  - 实时显示当前轮数进度

---

## 配置说明

### 自动总结配置
- **上下文读取长度**：AI能看多远的历史记录（独立设置）
- **自动总结轮数**：多久记一次笔记（独立设置）
- 两者互不干扰，按用户配置各自执行

### 轮数计算规则
1. **线上线下大一统**：线上线下属于同一个世界，上下文和记忆完全互通
2. **合并计算轮数**：当前总轮数 = 线上新增轮数 + 线下新增轮数
3. **自动触发机制**：当"当前总轮数"达到用户设定的"自动总结轮数"时，立刻抓取这段对话生成总结，并存入记忆App，然后计数器清零
4. **手动重置机制**：只要用户点击记忆App的"立即总结"，无论当前算到第几轮，立刻执行总结，且轮数计数器强制清零，重新从第1轮开始算

---

## 测试建议

### 测试场景0：线上线下记忆统一
1. 在线上模式聊天并触发自动总结
2. 切换到线下模式继续聊天并触发自动总结
3. 打开记忆App
4. 验证：
   - 只有一个记忆列表（没有Tab切换）
   - 线上和线下的总结都在同一个列表中
   - 可以统一编辑/删除所有记忆

### 测试场景1：线下聊天约束
1. 进入线下模式
2. 发送消息触发AI回复
3. 验证AI是否：
   - ❌ 没有替用户说话/行动
   - ❌ 没有重复之前的段落和句式
   - ✅ 只描写自己扮演的角色

### 测试场景2：统一轮数计算
1. 设置自动总结频率为5轮
2. 在线上模式发送3条消息（触发3次AI回复）
3. 切换到线下模式发送2条消息（触发2次AI回复）
4. 验证：
   - 记忆App显示轮数为 5/5
   - 自动触发总结
   - 总结后轮数重置为 0/5

### 测试场景3：手动总结重置
1. 在线上/线下模式发送若干消息（如3轮）
2. 打开记忆App，点击"立即总结"
3. 验证：
   - 生成总结成功
   - 轮数显示重置为 0/X
   - 继续聊天后轮数从0开始累加

### 测试场景4：线上线下互通
1. 在线上模式聊天
2. 切换到线下模式继续聊天
3. 验证：
   - 轮数持续累加（不重置）
   - 自动总结时合并线上线下历史
   - 总结内容包含线上和线下的对话

---

## 注意事项

1. **轮数定义**：1次AI回复 = 1轮，不按字数或消息数计算
2. **计数器存储**：使用 DataStore (IndexedDB) 存储，避免 localStorage 超限
3. **向后兼容**：旧的计数器数据会被自动迁移到新的统一计数器
4. **性能优化**：轮数计算使用缓存，避免重复遍历历史记录

---

## 相关文件

- [`api.js`](api.js) - 核心逻辑修改
- [`apps.js`](apps.js) - 记忆App UI更新
- [`components/memory-app.html`](components/memory-app.html) - 轮数显示UI
- [`chatRender/aiHandler.js`](chatRender/aiHandler.js) - 线上聊天AI处理
- [`chatRender/offlineMode.js`](chatRender/offlineMode.js) - 线下模式处理
