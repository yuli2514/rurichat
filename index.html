<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuriChat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RuriChat">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="h-screen w-screen flex items-center justify-center">

    <div id="phone-shell" class="relative w-[375px] h-[812px] bg-gray-100 rounded-[50px] shadow-2xl border-[8px] border-gray-800 overflow-hidden box-border flex flex-col transition-all duration-300">
        
        <!-- 顶部刘海 -->
        <div id="notch-container" class="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-7 bg-black rounded-b-2xl z-50 pointer-events-none transition-all duration-300"></div>
        
        <!-- 状态栏 -->
        <div id="status-bar" class="w-full h-12 px-6 flex justify-between items-end pb-2 text-xs font-medium text-black z-40 shrink-0 transition-all duration-300">
            <span id="status-bar-time">9:41</span>
            <div class="flex gap-1 items-center"><i class="fa-solid fa-signal"></i><i class="fa-solid fa-wifi"></i><i class="fa-solid fa-battery-full"></i></div>
        </div>

        <!-- 主屏幕内容 (包含滑动区域和Dock) -->
        <div id="home-screen" class="flex-1 flex flex-col w-full h-full overflow-hidden absolute top-0 left-0 pt-12 z-10 bg-gray-100 bg-cover bg-center">
             <!-- 滑动区域 -->
            <div id="swipe-container" class="flex-1 overflow-hidden relative w-full cursor-grab active:cursor-grabbing">
                <div id="slider-track" class="w-[200%] h-full flex transition-transform duration-300 ease-out">
                    
                    <!-- =============== PAGE 1 =============== -->
                    <div class="w-1/2 h-full flex flex-col px-6 pt-2 pb-2">
                        
                        <!-- [区域1] 个人信息 -->
                        <div class="flex flex-col mb-4 shrink-0 py-2 mt-4">
                            <div class="flex items-center gap-5">
                                <div class="relative group shrink-0">
                                    <label for="upload-avatar-top" class="cursor-pointer relative w-24 h-24 rounded-full border-4 border-white shadow-xl bg-gray-200 flex items-center justify-center overflow-hidden active:scale-95 transition">
                                        <span id="avatar-top-text" class="text-gray-400 text-xs font-bold">上传</span>
                                        <img id="avatar-top-preview" class="absolute inset-0 w-full h-full object-cover hidden bg-white">
                                    </label>
                                    <input type="file" id="upload-avatar-top" class="hidden" accept="image/*">
                                </div>
                                
                                <div class="flex-1 flex flex-col justify-center min-w-0 space-y-1">
                                    <h1 id="home-user-name" contenteditable="true" class="text-3xl font-black text-gray-900 leading-none tracking-tight truncate">Admin User</h1>
                                    <p id="home-user-id" contenteditable="true" class="text-base text-gray-600 font-medium leading-tight">ID: 9527001</p>
                                    <p id="home-user-location" contenteditable="true" class="flex items-center gap-1.5 text-gray-500 text-sm font-medium leading-tight">
                                        <i class="fa-solid fa-location-dot text-[12px]"></i> Shanghai, China
                                    </p>
                                </div>
                            </div>

                            <div class="mt-2 w-[85%] ml-6">
                                <p id="home-user-bio" contenteditable="true" class="text-[10px] text-gray-400 italic leading-tight break-words font-light">
                                    "Stay hungry, stay foolish. Design is not just what it looks like and feels like."
                                </p>
                            </div>
                        </div>

                        <!-- [区域2] 时间 & APP -->
                        <div class="flex items-center gap-4 shrink-0 mb-3 px-1">
                            <div class="flex gap-5 shrink-0">
                                <div id="chat-app-icon" class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition">
                                    <div class="w-12 h-12 glass-morphism rounded-2xl flex items-center justify-center text-gray-600 shadow-sm"><i class="fa-solid fa-comment-dots text-lg"></i></div>
                                    <span class="text-xs text-gray-500 font-medium">Chat</span>
                                </div>
                                <div id="worldbook-app-icon" class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition">
                                    <div class="w-12 h-12 glass-morphism rounded-2xl flex items-center justify-center text-gray-600 shadow-sm"><i class="fa-solid fa-book-atlas text-lg"></i></div>
                                    <span class="text-xs text-gray-500 font-medium">世界书</span>
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col justify-center items-center">
                                <div id="live-time" class="text-6xl font-light text-gray-800 leading-[0.8] tracking-tighter">14:00</div>
                                <div id="live-date" class="text-xs text-gray-400 font-medium uppercase tracking-wide mt-2">Mon, 23 Oct</div>
                            </div>
                        </div>

                        <!-- [区域3] 今日心情卡片 -->
                        <div class="w-full h-28 shrink-0 z-10">
                            <div class="w-full h-full bg-white/90 backdrop-blur rounded-3xl border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                                <div class="h-6 px-4 flex items-center border-b border-gray-100 bg-gray-50/50 shrink-0">
                                    <span class="text-[9px] text-gray-400 font-semibold tracking-wider w-full outline-none">每日推荐 · DAILY PICK</span>
                                </div>
                                <div class="flex-1 px-4 py-1.5 flex items-center gap-3 overflow-hidden">
                                    <div class="shrink-0 self-center">
                                        <label for="upload-avatar-card" class="cursor-pointer relative block w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden group">
                                            <span id="avatar-card-text" class="text-gray-400 text-[8px] font-bold">上传</span>
                                            <img id="avatar-card-preview" class="absolute inset-0 w-full h-full object-cover hidden bg-white">
                                            <input type="file" id="upload-avatar-card" class="hidden" accept="image/*">
                                        </label>
                                    </div>
                                    <div class="flex-1 overflow-hidden flex flex-col justify-center">
                                        <p id="home-mood-title" contenteditable="true" class="text-xs font-bold text-gray-800 mb-0.5 outline-none">今日心情</p>
                                        <p id="home-mood-content" contenteditable="true" class="text-[9px] text-gray-500 leading-relaxed outline-none break-words font-medium">点击这里编辑... 这里的文字现在变小了，更精致。</p>
                                    </div>
                                </div>
                                <div class="h-7 flex border-t border-gray-100 shrink-0">
                                    <button class="flex-1 flex items-center justify-center gap-1.5 text-gray-500 hover:text-red-500 transition text-[10px] font-semibold border-r border-gray-200">
                                        <i class="fa-regular fa-heart"></i><span>点赞</span>
                                    </button>
                                    <button class="flex-1 flex items-center justify-center gap-1.5 text-gray-500 hover:text-yellow-500 transition text-[10px] font-semibold border-r border-gray-200">
                                        <i class="fa-regular fa-star"></i><span>收藏</span>
                                    </button>
                                    <button class="flex-1 flex items-center justify-center gap-1.5 text-gray-500 hover:text-blue-500 transition text-[10px] font-semibold">
                                        <i class="fa-solid fa-share"></i><span>转发</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- [区域4] 底部功能区 -->
                        <div class="mt-3 grid grid-cols-2 gap-2 h-36 shrink-0">
                            <!-- 左侧上传图片区 -->
                            <div class="relative w-full h-full bg-gray-200/80 backdrop-blur rounded-2xl overflow-hidden border-2 border-dashed border-gray-300 hover:border-blue-400 transition group">
                                <img id="image-preview-rect" src="" class="absolute inset-0 w-full h-full object-cover hidden z-10 pointer-events-none bg-white">
                                <label for="upload-rect" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer z-20">
                                    <div id="upload-placeholder" class="text-gray-400 group-hover:text-blue-500 flex flex-col items-center">
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl mb-1"></i>
                                        <span class="text-[10px] font-bold">上传图片</span>
                                    </div>
                                </label>
                                <input type="file" id="upload-rect" accept="image/*" class="hidden">
                            </div>
                            
                            <!-- 右侧4个功能图标区 -->
                            <div class="grid grid-cols-2 grid-rows-2 gap-2 content-center">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <div class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-sm flex items-center justify-center cursor-pointer active:scale-95 transition hover:shadow-md">
                                        <i class="fa-solid fa-wand-magic-sparkles text-gray-600 text-xl"></i>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">美化</span>
                                </div>
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <div class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-sm flex items-center justify-center cursor-pointer active:scale-95 transition hover:shadow-md">
                                        <i class="fa-solid fa-brain text-gray-600 text-xl"></i>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">记忆</span>
                                </div>
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <div class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-sm flex items-center justify-center cursor-pointer active:scale-95 transition hover:shadow-md">
                                        <i class="fa-solid fa-calendar-days text-gray-600 text-xl"></i>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">纪念日</span>
                                </div>
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <div class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-sm flex items-center justify-center cursor-pointer active:scale-95 transition hover:shadow-md">
                                        <i class="fa-solid fa-users text-gray-600 text-xl"></i>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">论坛</span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- PAGE 2 -->
                    <div class="w-1/2 h-full flex flex-col items-center justify-center p-8 text-gray-400" style="touch-action: pan-x; min-height: 100%;">
                        <div class="text-center space-y-4 opacity-50 pointer-events-none">
                            <i class="fa-solid fa-plus-circle text-6xl text-gray-300"></i>
                            <p class="text-sm font-medium">第二页空间</p>
                            <p class="text-xs">← 向右滑动返回</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Dock -->
            <div class="w-full flex justify-center gap-2 mb-2 z-50 pointer-events-none">
                <div id="dot-1" class="w-2 h-2 rounded-full bg-gray-800 transition-colors"></div>
                <div id="dot-2" class="w-2 h-2 rounded-full bg-gray-300 transition-colors"></div>
            </div>

            <div class="w-full h-24 px-4 flex items-start justify-center shrink-0 z-50">
                <div class="w-full h-20 glass-morphism rounded-[35px] flex items-center justify-around px-6">
                    <div class="cursor-pointer active:scale-90 transition"><div class="w-12 h-12 glass-morphism rounded-2xl flex items-center justify-center text-gray-600 text-xl shadow-sm"><i class="fa-solid fa-comment"></i></div></div>
                    <div class="cursor-pointer active:scale-90 transition"><div class="w-12 h-12 glass-morphism rounded-2xl flex items-center justify-center text-gray-600 text-xl shadow-sm"><i class="fa-solid fa-phone"></i></div></div>
                    <!-- Settings Icon -->
                    <div id="settings-icon" class="cursor-pointer active:scale-90 transition"><div class="w-12 h-12 glass-morphism rounded-2xl flex items-center justify-center text-gray-600 text-xl shadow-sm"><i class="fa-solid fa-gear"></i></div></div>
                </div>
            </div>
        </div>

        <!-- ==================== CHAT APP ==================== -->
        <div id="chat-app" class="absolute inset-0 z-50 flex flex-col hidden pt-0 overflow-hidden bg-[#f5f5f5]">
            
            <!-- Chat Status Bar Spacer (Uses Global Status Bar) -->
            <div class="h-12 w-full bg-[#f5f5f5] shrink-0"></div>

            <!-- Chat Header -->
            <div class="h-10 px-4 bg-[#f5f5f5] flex items-center justify-between shrink-0 border-b border-gray-200/50 sticky top-0 z-10 relative">
                <button id="close-chat-btn" class="text-black active:text-gray-600 transition"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                <span class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">RuriChat</span>
                <button onclick="ChatManager.openAddModal()" class="text-black active:text-gray-600 transition p-1">
                    <i class="fa-solid fa-user-plus text-lg"></i>
                </button>
            </div>

            <!-- Chat List Content -->
            <div id="chat-list-container" class="flex-1 overflow-y-auto no-scrollbar">
                <!-- List Items will be injected here -->
                <div class="flex flex-col items-center justify-center h-48 text-gray-400 mt-10">
                    <i class="fa-regular fa-comment-dots text-4xl mb-2 opacity-50"></i>
                    <p class="text-xs">暂无聊天</p>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="chat-bottom-nav h-[84px] w-full flex justify-around items-start pt-2 pb-8 shrink-0 relative z-20">
                <div class="flex flex-col items-center gap-0.5 w-16 cursor-pointer text-[#2c2c2e]">
                    <i class="fa-solid fa-comment text-xl"></i>
                    <span class="text-[10px] font-medium">聊天</span>
                </div>
                <div class="flex flex-col items-center gap-0.5 w-16 cursor-pointer text-gray-400 hover:text-[#2c2c2e] transition">
                    <i class="fa-regular fa-compass text-xl"></i>
                    <span class="text-[10px] font-medium">动态</span>
                </div>
                <div onclick="ProfileManager.open()" class="flex flex-col items-center gap-0.5 w-16 cursor-pointer text-gray-400 hover:text-[#2c2c2e] transition">
                    <i class="fa-regular fa-user text-xl"></i>
                    <span class="text-[10px] font-medium">我</span>
                </div>
            </div>

            <!-- Character Long Press Menu -->
            <div id="char-context-menu" class="absolute z-[60] hidden">
                <div class="bg-white rounded-xl shadow-2xl overflow-hidden min-w-[120px] border border-gray-100">
                    <button id="char-menu-pin" class="w-full px-4 py-3 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 active:bg-gray-100 flex items-center gap-2 border-b border-gray-100">
                        <i class="fa-solid fa-thumbtack text-gray-400"></i>
                        <span>置顶</span>
                    </button>
                    <button id="char-menu-delete" class="w-full px-4 py-3 text-left text-sm font-medium text-red-500 hover:bg-red-50 active:bg-red-100 flex items-center gap-2">
                        <i class="fa-solid fa-trash"></i>
                        <span>删除</span>
                    </button>
                </div>
            </div>

            <!-- Add Character Modal -->
            <div id="add-char-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-all duration-200">
                <div id="add-char-modal-content" class="bg-white w-[85%] max-w-[320px] rounded-2xl p-5 shadow-2xl transform transition-all duration-200 scale-95 opacity-0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-gray-800">添加新角色</h3>
                        <button onclick="ChatManager.closeAddModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Avatar Section -->
                        <div class="flex items-center gap-4">
                            <div class="relative w-16 h-16 shrink-0">
                                <img id="new-char-avatar-preview" src="https://ui-avatars.com/api/?name=New" class="w-full h-full rounded-full object-cover border border-gray-200 bg-gray-50">
                                <label for="new-char-file" class="absolute bottom-[-4px] right-[-4px] w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white cursor-pointer shadow-sm border border-white">
                                    <i class="fa-solid fa-camera text-[10px]"></i>
                                </label>
                                <input type="file" id="new-char-file" class="hidden" accept="image/*" onchange="ChatManager.handleAvatarFile(this)">
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase mb-1 block">网络图片 URL (可选)</label>
                                <input type="text" id="new-char-url" class="w-full bg-gray-100 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." oninput="ChatManager.handleAvatarUrl(this)">
                            </div>
                        </div>

                        <!-- Info Inputs -->
                        <div class="space-y-2">
                            <div>
                                <input type="text" id="new-char-name" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" placeholder="角色姓名 (Name)">
                            </div>
                            <div>
                                <input type="text" id="new-char-remark" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" placeholder="备注 (Remark) - 显示在列表">
                            </div>
                            <div>
                                <input type="text" id="new-char-user-name" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" placeholder="你的称呼 (用于记忆总结)">
                            </div>
                            <div>
                                <textarea id="new-char-prompt" rows="3" class="w-full bg-gray-100 rounded-lg p-2.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400 resize-none" placeholder="填写角色人设"></textarea>
                            </div>
                        </div>

                        <button onclick="ChatManager.saveCharacter()" class="w-full bg-gray-700 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition hover:bg-gray-600">添加角色</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- ==================== PROFILE APP (INS Style) ==================== -->
        <div id="profile-app" class="absolute inset-0 z-50 flex flex-col hidden bg-white">
            
            <!-- Header Bar (Transparent) -->
            <div class="absolute top-0 left-0 right-0 h-24 px-4 pt-10 flex items-center justify-between z-30">
                 <button onclick="ProfileManager.close()" class="w-9 h-9 flex items-center justify-center rounded-full bg-black/20 backdrop-blur-sm text-white">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <button onclick="ProfileManager.saveAll()" class="w-16 h-8 flex items-center justify-center rounded-full bg-black text-white text-xs font-bold shadow-md active:scale-95 transition">
                    保存
                </button>
            </div>

            <!-- Header Image Area -->
            <div class="relative w-full h-48 shrink-0 bg-gray-100 group cursor-pointer">
                <div id="profile-bg-preview" class="w-full h-full bg-cover bg-center bg-gray-300 transition group-active:opacity-90"></div>
                <!-- Full area label -->
                <label for="profile-bg-upload" class="absolute inset-0 flex items-center justify-center bg-black/0 group-hover:bg-black/10 transition cursor-pointer">
                     <div class="w-8 h-8 bg-black/50 backdrop-blur rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition">
                        <i class="fa-solid fa-camera text-xs"></i>
                    </div>
                </label>
                <input type="file" id="profile-bg-upload" class="hidden" accept="image/*">
            </div>

            <!-- Profile Avatar (Absolute Positioned to float over header) -->
            <div class="absolute top-28 left-1/2 transform -translate-x-1/2 z-40">
                <label for="profile-avatar-upload" class="relative block w-24 h-24 p-1 bg-white rounded-full shadow-lg cursor-pointer active:scale-95 transition">
                    <img id="profile-avatar-preview" src="https://ui-avatars.com/api/?name=User" class="w-full h-full rounded-full object-cover bg-gray-100">
                    <input type="file" id="profile-avatar-upload" class="hidden" accept="image/*">
                </label>
            </div>

            <!-- Profile Content Area -->
            <div class="flex-1 overflow-y-auto relative -mt-6 rounded-t-[30px] bg-white z-10 px-6 pt-16">
                
                <!-- Main Info (Centered) -->
                <div class="flex flex-col items-center mb-6 mt-8">
                    <input type="text" id="profile-name" class="text-center text-xl font-black text-gray-900 bg-transparent focus:bg-gray-50 focus:outline-none rounded-lg px-2 py-1 w-full max-w-[80%]" placeholder="Name">
                    
                    <div class="inline-flex items-center justify-center text-gray-400 mt-1">
                        <i class="fa-solid fa-location-dot text-[10px]"></i>
                        <input type="text" id="profile-location" class="text-xs font-medium text-gray-500 bg-transparent focus:bg-gray-50 focus:outline-none rounded px-1 text-center" style="width: auto; min-width: 50px; max-width: 120px;" placeholder="Location" oninput="this.style.width = Math.max(50, (this.value.length + 2) * 7) + 'px'">
                    </div>

                    <input type="text" id="profile-signature" class="text-center text-xs text-gray-400 mt-2 bg-transparent focus:bg-gray-50 focus:outline-none rounded px-2 w-full" placeholder="Bio / Signature...">
                </div>

                <!-- Stats / Action Buttons (Ins Style) -->
                <div class="flex gap-3 mb-6">
                    <button class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-lg text-sm font-bold active:bg-gray-200 transition">编辑主页</button>
                    <button class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-lg text-sm font-bold active:bg-gray-200 transition">分享</button>
                    <button onclick="ProfileManager.openPresetModal()" class="w-10 flex items-center justify-center bg-gray-100 text-gray-800 rounded-lg active:bg-gray-200 transition">
                         <i class="fa-solid fa-user-gear"></i>
                    </button>
                </div>

                <!-- Character / System Prompt Section -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2 mb-1">
                         <span class="text-xs font-bold text-gray-900 tracking-wide uppercase">System Prompt</span>
                         <div class="h-px bg-gray-200 flex-1"></div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4">
                        <textarea id="profile-character" rows="10" class="w-full bg-transparent text-sm text-gray-700 focus:outline-none resize-none leading-relaxed placeholder-gray-400" placeholder="在此设定你的角色人设 (System Prompt)..."></textarea>
                    </div>
                    <p class="text-[10px] text-gray-400 text-center">Prompt will define how AI responds to you.</p>
                </div>

                <!-- Spacer -->
                <div class="h-10"></div>
            </div>
        </div>

        <!-- Character Preset Modal -->
        <div id="preset-modal" class="absolute inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-[90%] max-w-[340px] rounded-2xl shadow-2xl max-h-[80%] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-lg">人设预设</h3>
                    <button onclick="ProfileManager.closePresetModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="preset-list" class="space-y-2">
                        <!-- Presets will be injected here -->
                    </div>
                </div>

                <div class="p-4 border-t border-gray-200 shrink-0">
                    <button onclick="ProfileManager.createNewPreset()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl active:scale-95 transition">
                        <i class="fa-solid fa-plus mr-2"></i>新建预设
                    </button>
                </div>
            </div>
        </div>

        <!-- User Persona Modal -->
        <div id="user-persona-modal" class="absolute inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-[90%] max-w-[340px] rounded-2xl shadow-2xl max-h-[80%] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-lg">用户面具预设</h3>
                    <button onclick="PersonaManager.closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="user-persona-list" class="space-y-2">
                        <!-- Presets will be injected here -->
                    </div>
                </div>

                <div class="p-4 border-t border-gray-200 shrink-0">
                    <button onclick="PersonaManager.create()" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl active:scale-95 transition">
                        <i class="fa-solid fa-plus mr-2"></i>新建面具
                    </button>
                </div>
            </div>
        </div>

        <!-- User Persona Edit Modal -->
        <div id="user-persona-edit-modal" class="absolute inset-0 bg-black/40 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-[90%] max-w-[340px] rounded-2xl shadow-2xl max-h-[85%] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                    <button onclick="PersonaManager.closeEditModal()" class="text-gray-500">取消</button>
                    <h3 class="font-bold text-lg">编辑面具</h3>
                    <button onclick="PersonaManager.save()" class="text-indigo-600 font-bold">保存</button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <input type="hidden" id="edit-persona-index">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">面具名称</label>
                        <input type="text" id="edit-persona-name" class="w-full bg-gray-100 rounded-lg p-3 font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">面具内容 (用户人设)</label>
                        <textarea id="edit-persona-content" rows="12" class="w-full bg-gray-100 rounded-lg p-3 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 leading-relaxed resize-none" placeholder="输入用户人设..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== EMOJI MANAGER APP ==================== -->
        <div id="emoji-manager-modal" class="absolute inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-[90%] max-w-[340px] rounded-2xl shadow-2xl max-h-[80%] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-lg">表情包管理</h3>
                    <button onclick="EmojiManager.closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Batch Import Section -->
                    <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                        <label class="block text-xs font-bold text-gray-600 uppercase">批量导入表情包</label>
                        <input type="text" id="emoji-group-name" class="w-full bg-white rounded-lg p-2 text-sm border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="分组名称 (必填)">
                        <textarea id="emoji-batch-input" rows="6" class="w-full bg-white rounded-lg p-2 text-xs border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none font-mono" placeholder="格式：含义:URL 或 含义 URL&#10;每行一个，例如：&#10;开心:https://example.com/happy.gif&#10;难过 https://example.com/sad.gif"></textarea>
                        <button onclick="EmojiManager.batchImport()" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg active:scale-95 transition">导入表情包</button>
                    </div>

                    <!-- Existing Groups -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-2">已有分组</label>
                        <div id="emoji-groups-list" class="space-y-2">
                            <!-- Groups will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MEMORY APP ==================== -->
        <div id="memory-app" class="absolute inset-0 z-50 flex flex-col hidden pt-0 overflow-hidden bg-[#F2F2F7]">
            <!-- Header -->
            <div class="h-24 bg-[#F7F7F7] px-6 pt-10 flex justify-between items-center shrink-0 border-b border-[#E5E5E5]">
                <button id="close-memory-btn" class="text-black"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                <h1 class="text-black font-bold text-xl tracking-wide">记忆时间轴</h1>
                <div class="w-6"></div>
            </div>

            <!-- Character Selection (Initial View) -->
            <div id="memory-char-select" class="flex-1 overflow-y-auto p-4">
                <p class="text-sm text-gray-500 mb-4 text-center">选择一个角色查看其记忆</p>
                <div id="memory-char-list" class="space-y-3">
                    <!-- Character cards will be injected here -->
                </div>
            </div>

            <!-- Memory Timeline (After selecting character) -->
            <div id="memory-timeline" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-4 bg-white border-b border-gray-200 flex items-center gap-3 shrink-0">
                    <button onclick="MemoryApp.backToCharSelect()" class="text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                    <img id="memory-current-avatar" src="" class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-1">
                        <h3 id="memory-current-name" class="font-bold text-gray-800"></h3>
                        <p class="text-xs text-gray-400">记忆总数: <span id="memory-count">0</span></p>
                    </div>
                    <button onclick="MemoryApp.addManualMemory()" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold active:scale-95 transition mr-2"><i class="fa-solid fa-plus"></i></button>
                    <button onclick="MemoryApp.triggerSummary()" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold active:scale-95 transition">立即总结</button>
                </div>
                
                <div id="memory-cards-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Memory cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- ==================== WORLD BOOK APP ==================== -->
        <div id="worldbook-app" class="absolute inset-0 z-50 flex flex-col hidden pt-0 overflow-hidden bg-[#F2F2F7]">
            <!-- Header -->
            <div class="h-24 bg-[#F7F7F7] px-6 pt-10 flex justify-between items-center shrink-0 border-b border-[#E5E5E5]">
                <button id="close-worldbook-btn" class="text-black"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                <h1 class="text-black font-bold text-xl tracking-wide">世界书</h1>
                <button onclick="WorldBookManager.openEditModal()" class="text-black"><i class="fa-solid fa-plus text-lg"></i></button>
            </div>
            
            <!-- List -->
            <div id="worldbook-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-8">
                <!-- Items injected by JS -->
            </div>

            <!-- Edit Modal -->
            <div id="worldbook-modal" class="absolute inset-0 bg-white z-50 hidden flex flex-col">
                <div class="h-16 border-b border-gray-200 flex justify-between items-center px-4 bg-gray-50">
                    <button onclick="WorldBookManager.closeEditModal()" class="text-gray-500">取消</button>
                    <span class="font-bold text-gray-800">编辑设定</span>
                    <button onclick="WorldBookManager.saveWorldBook()" class="text-indigo-600 font-bold">保存</button>
                </div>
                <div class="flex-1 p-4 overflow-y-auto space-y-4">
                    <input type="hidden" id="wb-id">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">书名 / Title</label>
                        <input type="text" id="wb-title" class="w-full bg-gray-100 rounded-lg p-3 font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">分类 / Category</label>
                        <input type="text" id="wb-category" class="w-full bg-gray-100 rounded-lg p-3 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="例如：世界观、魔法体系...">
                    </div>
                    <div class="flex-1 h-full">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">详细设定 / Content</label>
                        <textarea id="wb-content" class="w-full h-64 bg-gray-100 rounded-lg p-3 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 leading-relaxed resize-none" placeholder="输入详细的世界观设定..."></textarea>
                    </div>
                    <button onclick="WorldBookManager.deleteWorldBook()" id="wb-delete-btn" class="w-full py-3 text-red-500 font-bold bg-red-50 rounded-xl hidden">删除此设定</button>
                </div>
            </div>
        </div>

        <!-- ==================== SUPER CHAT INTERFACE ==================== -->
        <div id="super-chat-interface" class="absolute inset-0 z-[60] flex flex-col hidden bg-[#f5f5f5]">
             <!-- Chat Header (WeChat Style) -->
             <div class="h-24 bg-white px-4 pt-10 flex items-center justify-between shrink-0 border-b border-gray-200 sticky top-0 z-20">
                <button onclick="ChatInterface.closeToList()" class="text-[#333333] text-lg w-10 flex justify-start">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <h1 id="chat-header-name" class="font-bold text-base text-gray-900">角色名</h1>
                <button onclick="ChatSettings.open()" class="text-[#333333] w-10 flex justify-end">
                    <i class="fa-solid fa-ellipsis text-xl"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f5f5f5] scroll-smooth relative">
                <!-- Messages injected here -->
            </div>

            <!-- Context Menu for Chat Bubbles -->
            <div id="chat-context-menu" class="absolute hidden bg-white/95 backdrop-blur-md rounded-xl shadow-xl overflow-hidden transform transition-all duration-200 origin-top-left w-36" style="z-index: 9999;">
                <div class="flex flex-col py-1" onclick="event.stopPropagation()">
                    <button onpointerup="ChatInterface.handleContextAction('copy')" class="context-menu-btn px-4 py-3 text-left text-sm text-gray-800 active:bg-gray-100 flex items-center gap-3 border-b border-gray-100/50">
                        <i class="fa-regular fa-copy text-xs"></i> <span>复制</span>
                    </button>
                    <button onpointerup="ChatInterface.handleContextAction('quote')" class="context-menu-btn px-4 py-3 text-left text-sm text-gray-800 active:bg-gray-100 flex items-center gap-3 border-b border-gray-100/50">
                        <i class="fa-solid fa-quote-left text-xs"></i> <span>引用</span>
                    </button>
                    <button onpointerup="ChatInterface.handleContextAction('edit')" class="context-menu-btn px-4 py-3 text-left text-sm text-gray-800 active:bg-gray-100 flex items-center gap-3 border-b border-gray-100/50">
                        <i class="fa-solid fa-pen text-xs"></i> <span>编辑</span>
                    </button>
                    <button onpointerup="ChatInterface.handleContextAction('recall')" class="context-menu-btn px-4 py-3 text-left text-sm text-orange-500 active:bg-gray-100 flex items-center gap-3 border-b border-gray-100/50">
                        <i class="fa-solid fa-rotate-left text-xs"></i> <span>撤回</span>
                    </button>
                    <button onpointerup="ChatInterface.handleContextAction('delete')" class="context-menu-btn px-4 py-3 text-left text-sm text-red-500 active:bg-gray-100 flex items-center gap-3">
                        <i class="fa-regular fa-trash-can text-xs"></i> <span>删除</span>
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-[#f7f7f7] border-t border-gray-300 min-h-[50px] shrink-0 z-20">
                <!-- Quote Preview Bar (WeChat Style) -->
                <div id="quote-preview" class="hidden mx-3 mt-2 mb-1 px-2 py-1.5 bg-[#f0f0f0] rounded flex justify-between items-center text-xs text-gray-600 border-l-2 border-[#95ec69]">
                    <div class="flex items-center gap-1.5 truncate max-w-[85%]">
                        <span id="quote-content-text" class="truncate text-[11px]">引用内容...</span>
                    </div>
                    <button onclick="ChatInterface.cancelQuote()" class="w-4 h-4 flex items-center justify-center text-gray-400 hover:text-gray-600 transition"><i class="fa-solid fa-xmark text-[10px]"></i></button>
                </div>

                <div class="flex items-end gap-2 p-2 relative">
                     <!-- Expand Btn - 透明底普通加号黑色 -->
                    <button onclick="ChatInterface.togglePanel('expand')" class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full hover:bg-gray-200 transition active:scale-90 mb-1">
                         <i class="fa-solid fa-plus text-xl text-black"></i>
                    </button>
                    
                    <!-- Input -->
                    <textarea id="chat-input" rows="1" class="flex-1 bg-white rounded-xl px-3 py-2.5 text-base max-h-32 focus:outline-none border-none resize-none m-0 shadow-sm leading-5" placeholder=""></textarea>
                    
                    <!-- Emoji Btn - 黑色 -->
                    <button onclick="ChatInterface.togglePanel('emoji')" class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full hover:bg-gray-200 transition mb-1">
                        <i class="fa-regular fa-face-smile text-2xl text-black"></i>
                    </button>
                    
                    <!-- AI Reply Btn (Send) - 透明底发送箭头黑色 -->
                    <div class="flex gap-1 shrink-0 mb-1">
                         <!-- Manual Send (Enter) logic is hidden, this button triggers AI -->
                        <button onclick="ChatInterface.triggerAI()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 active:scale-90 transition">
                            <i class="fa-solid fa-paper-plane text-xl text-black"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Panels -->
                <div id="panel-container" class="hidden overflow-hidden transition-all duration-300 bg-[#f7f7f7]">
                    
                    <!-- Emoji Panel -->
                    <div id="panel-emoji" class="hidden h-64 flex flex-col">
                        <!-- Group Selector Bar -->
                        <div id="emoji-group-bar" class="flex overflow-x-auto border-b border-gray-200 bg-white no-scrollbar shrink-0">
                            <!-- Injected Groups -->
                            <button class="px-4 py-2 text-xs font-medium text-gray-500 whitespace-nowrap border-b-2 border-transparent">默认</button>
                        </div>
                        
                        <div id="emoji-grid" class="flex-1 overflow-y-auto p-4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; align-content: start;">
                            <!-- Emoji Items -->
                        </div>
                    </div>

                    <!-- Expand Panel -->
                    <div id="panel-expand" class="hidden h-64 p-6">
                        <div class="grid grid-cols-4 gap-6">
                            <!-- 第一排：重回、拍照、照片、语音 -->
                            <div onclick="ChatInterface.regenerateLastAI()" class="flex flex-col items-center gap-2 text-gray-500 cursor-pointer active:scale-95 transition">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-rotate text-2xl text-gray-600"></i></div>
                                <span class="text-xs">重回</span>
                            </div>
                            <div onclick="ChatInterface.openCamera()" class="flex flex-col items-center gap-2 text-gray-500 cursor-pointer active:scale-95 transition">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-camera text-2xl text-gray-600"></i></div>
                                <span class="text-xs">拍照</span>
                            </div>
                            <div onclick="ChatInterface.openGalleryMenu()" class="flex flex-col items-center gap-2 text-gray-500 cursor-pointer active:scale-95 transition">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-regular fa-image text-2xl text-gray-600"></i></div>
                                <span class="text-xs">照片</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-microphone text-2xl text-gray-600"></i></div>
                                <span class="text-xs">语音</span>
                            </div>
                            <!-- 第二排：转账、语音通话、视频通话、线下模式 -->
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-money-bill-transfer text-2xl text-gray-600"></i></div>
                                <span class="text-xs">转账</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-phone text-2xl text-gray-600"></i></div>
                                <span class="text-xs">语音通话</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-video text-2xl text-gray-600"></i></div>
                                <span class="text-xs">视频通话</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center border border-gray-200"><i class="fa-solid fa-plane-slash text-2xl text-gray-600"></i></div>
                                <span class="text-xs">线下模式</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Sub-Menu Modal -->
                    <div id="gallery-submenu" class="hidden absolute bottom-72 left-1/2 transform -translate-x-1/2 bg-white rounded-2xl shadow-2xl p-4 z-50 w-64">
                        <div class="flex flex-col gap-3">
                            <button onclick="ChatInterface.openTextDrawing()" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 active:scale-95 transition">
                                <i class="fa-solid fa-pen-fancy text-blue-500 text-lg w-6"></i>
                                <span class="text-sm font-medium text-gray-700">文字描述画图</span>
                            </button>
                            <button onclick="ChatInterface.openGalleryPicker()" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 active:scale-95 transition">
                                <i class="fa-regular fa-images text-green-500 text-lg w-6"></i>
                                <span class="text-sm font-medium text-gray-700">从相册选择</span>
                            </button>
                        </div>
                        <button onclick="ChatInterface.closeGalleryMenu()" class="absolute -top-2 -right-2 w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-300">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </button>
                    </div>

                    <!-- Text Drawing Modal -->
                    <div id="text-drawing-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-[100]">
                        <div class="bg-white rounded-2xl p-5 w-[85%] max-w-[300px] shadow-2xl">
                            <h3 class="font-bold text-lg text-gray-800 mb-3">文字描述画图</h3>
                            <textarea id="text-drawing-input" rows="4" class="w-full bg-gray-100 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="描述你想要的图片内容..."></textarea>
                            <div class="flex gap-2 mt-4">
                                <button onclick="ChatInterface.closeTextDrawing()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-xl font-medium active:scale-95 transition">取消</button>
                                <button onclick="ChatInterface.sendTextDrawing()" class="flex-1 py-2 bg-blue-500 text-white rounded-xl font-medium active:scale-95 transition">发送</button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden file inputs for camera and gallery -->
                    <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment" onchange="ChatInterface.handleCameraCapture(this)">
                    <input type="file" id="gallery-input" class="hidden" accept="image/*" onchange="ChatInterface.handleGallerySelect(this)">

                </div>
                <!-- Bottom Spacer for Safe Area -->
                <div class="h-5 w-full shrink-0 bg-[#f7f7f7]"></div>
            </div>
        </div>

        <!-- ==================== CHAT SETTINGS PANEL ==================== -->
        <div id="chat-settings-panel" class="absolute inset-0 z-[70] flex flex-col hidden bg-gray-100 transform translate-x-full transition-transform duration-300">
            <div class="h-24 bg-white px-4 pt-10 flex items-center justify-between shrink-0 shadow-sm">
                <button onclick="ChatSettings.close()" class="text-gray-800"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                <h2 class="font-bold text-lg">聊天信息</h2>
                <div class="w-6"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Avatar & Name - 整个设置面板背景 -->
                <div id="setting-panel-header" class="relative bg-white min-h-[200px] rounded-xl shadow-sm overflow-hidden" style="background-size: cover; background-position: center;">
                    <!-- 全面板背景 -->
                    <div id="setting-panel-bg-preview" class="absolute inset-0 bg-cover bg-center opacity-0 transition-opacity duration-300" style="background-size: cover; background-position: center;"></div>
                    <label for="setting-panel-bg-upload" class="absolute inset-0 w-full h-full cursor-pointer z-50 opacity-0 hover:opacity-100 transition pointer-events-none"></label>
                    <input type="file" id="setting-panel-bg-upload" class="hidden absolute inset-0 w-full h-full cursor-pointer z-40 opacity-0" accept="image/*" onchange="ChatSettings.updatePanelBackground(this)">
                    
                    <!-- 小相机按钮 - 右上角 -->
                    <label for="setting-panel-bg-upload" class="absolute top-4 right-4 z-40 w-10 h-10 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg border border-white cursor-pointer hover:bg-white transition group pointer-events-auto">
                        <i class="fa-solid fa-camera text-gray-600 text-sm group-hover:text-blue-500 transition-colors"></i>
                    </label>
                    
                    <!-- Header 内容区域 -->
                    <div class="relative z-30 pt-20 pb-12 px-6">
                        <!-- 头像行 -->
                        <div class="flex items-center justify-center gap-6 mb-6 relative">
                            <!-- Character Avatar -->
                            <div class="relative">
                                <div class="cursor-pointer" onclick="event.stopPropagation(); document.getElementById('setting-char-upload').click()">
                                    <img id="setting-char-avatar" src="" class="vinyl-record w-16 h-16 rounded-full object-cover shadow-2xl bg-gray-200">
                                    <input type="file" id="setting-char-upload" class="hidden" accept="image/*" onchange="ChatSettings.updateAvatar(this)">
                                </div>
                                <!-- AI小字 - 正上方居中，可点击编辑像打字 -->
                                <div class="absolute -top-7 left-1/2 transform -translate-x-1/2 text-center w-24 z-20">
                                    <span id="setting-char-name-display" class="text-xs text-gray-500 font-medium block cursor-text select-text" contenteditable="true" onblur="ChatSettings.saveCharNameEdit(this)" onkeydown="if(event.key==='Enter') {event.preventDefault(); ChatSettings.saveCharNameEdit(this); }">AI名</span>
                                </div>
                                <!-- AI英文小字 - 正下方居中 -->
                                <div class="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-center w-32 z-20">
                                    <span id="setting-char-en-text" class="text-[10px] text-gray-500 italic font-serif block cursor-text select-text" contenteditable="true" onblur="ChatSettings.saveCharEnText(this)" onkeydown="if(event.key==='Enter') {event.preventDefault(); ChatSettings.saveCharEnText(this); }">Character</span>
                                </div>
                            </div>
                            
                            <!-- 可自定义emoji - 直接点击编辑文字/上传图片，删除直接用退格键 -->
                            <div class="relative flex items-center justify-center group cursor-pointer" onclick="event.stopPropagation()">
                                <span id="setting-music-emoji-text" class="text-[24px] text-gray-600 font-normal cursor-text select-text" contenteditable="true" onblur="ChatSettings.saveMusicEmojiText(this)" onkeydown="if(event.key==='Enter') {event.preventDefault(); ChatSettings.saveMusicEmojiText(this); }">🎵</span>
                                <input type="file" id="setting-music-upload" class="hidden absolute inset-0 opacity-0 cursor-pointer z-20" accept="image/*" onchange="ChatSettings.updateMusicEmoji(this)">
                                <!-- 点击提示 -->
                                <div class="absolute -top-10 text-xs text-gray-500 bg-white/90 backdrop-blur rounded px-2 py-1 shadow-md whitespace-nowrap opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-30">点击编辑表情符号</div>
                            </div>
                            
                            <!-- User Avatar -->
                            <div class="relative">
                                <div class="cursor-pointer" onclick="event.stopPropagation(); document.getElementById('setting-user-upload').click()">
                                    <img id="setting-user-avatar" src="" class="vinyl-record w-16 h-16 rounded-full object-cover shadow-2xl bg-gray-200">
                                    <input type="file" id="setting-user-upload" class="hidden" accept="image/*" onchange="ChatSettings.updateUserAvatar(this)">
                                </div>
                                <!-- 用户小字 - 正上方居中，可直接编辑 -->
                                <div class="absolute -top-7 left-1/2 transform -translate-x-1/2 text-center w-24 z-20">
                                    <span id="setting-user-name-display" class="text-xs text-gray-500 font-medium block cursor-text select-text" contenteditable="true" onblur="ChatSettings.saveUserName(this)" onkeydown="if(event.key==='Enter') {event.preventDefault(); ChatSettings.saveUserName(this); }">用户</span>
                                </div>
                                <!-- 用户英文小字 - 正下方居中 -->
                                <div class="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-center w-32 z-20">
                                    <span id="setting-user-en-text" class="text-[10px] text-gray-500 italic font-serif block cursor-text select-text" contenteditable="true" onblur="ChatSettings.saveUserEnText(this)" onkeydown="if(event.key==='Enter') {event.preventDefault(); ChatSettings.saveUserEnText(this); }">User</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Edit Character Info (包含备注) -->
                        <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-700">角色信息</span>
                                <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                            </div>
                            <div class="p-4 bg-gray-50 space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">显示备注</label>
                                    <input type="text" id="setting-char-remark" class="w-full bg-white border border-gray-300 text-gray-700 p-2 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 text-xs" placeholder="聊天列表和标题显示的备注">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">你的称呼 (用于记忆总结)</label>
                                    <input type="text" id="setting-user-name-for-summary" class="w-full bg-white border border-gray-300 text-gray-700 p-2 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 text-xs" placeholder="AI总结记忆时使用的你的名字">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">系统设定 (Prompt)</label>
                                    <textarea id="setting-char-prompt" rows="3" class="w-full bg-white border border-gray-300 text-gray-700 p-2 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 text-xs resize-none" placeholder="输入角色的系统设定..."></textarea>
                                </div>
                                <button onclick="ChatSettings.saveCharInfo()" class="w-full bg-blue-500 text-white font-medium py-1.5 rounded-md text-xs active:scale-95 transition">保存信息</button>
                            </div>
                        </div>

                <!-- World Book Binding - 可折叠，按目录展示 -->
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer" onclick="document.getElementById('worldbook-binding-content').classList.toggle('hidden'); document.getElementById('worldbook-arrow').classList.toggle('rotate-90')">
                        <span class="text-sm font-bold text-gray-700">世界书绑定</span>
                        <i id="worldbook-arrow" class="fa-solid fa-chevron-right text-gray-300 text-xs transition-transform duration-200"></i>
                    </div>
                    <div id="worldbook-binding-content" class="hidden p-4 bg-gray-50">
                        <!-- 世界书目录树 -->
                        <div id="worldbook-tree-container" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- 目录和世界书将由JS注入 -->
                        </div>
                        <p class="text-[10px] text-gray-400 mt-3">勾选后，AI 将读取该世界书的设定作为背景知识。支持多选。</p>
                    </div>
                </div>

                <!-- User Persona Section -->
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer" onclick="document.getElementById('user-persona-content').classList.toggle('hidden'); document.getElementById('persona-arrow').classList.toggle('rotate-90')">
                        <span class="text-sm font-bold text-gray-700">用户人设</span>
                        <i id="persona-arrow" class="fa-solid fa-chevron-right text-gray-300 text-xs transition-transform duration-200"></i>
                    </div>
                    <div id="user-persona-content" class="hidden p-4 bg-gray-50 space-y-3">
                        <!-- Persona Preset Select -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">选择预设</label>
                            <div class="flex gap-2">
                                <select id="setting-user-persona-select" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onchange="ChatSettings.saveUserPersona()">
                                    <option value="">(默认用户)</option>
                                    <!-- Options injected -->
                                </select>
                                <button onclick="ChatSettings.openPersonaManager()" class="bg-gray-200 text-gray-600 px-3 rounded-lg text-sm hover:bg-gray-300 transition">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Persona Content (Read-only preview) -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">当前人设内容</label>
                            <textarea id="setting-user-persona-content" rows="4" class="w-full bg-white border border-gray-300 text-gray-700 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs resize-none" placeholder="选择预设后显示人设内容，或直接输入临时人设..." oninput="ChatSettings.saveCustomPersona()"></textarea>
                        </div>
                        
                        <p class="text-[10px] text-gray-400">AI 将明确知道对面聊天的人是用户，并根据此人设理解用户身份。</p>
                    </div>
                </div>

                <!-- Chat Wallpaper -->
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">聊天背景</span>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                    <div class="p-4 bg-gray-50 flex flex-col gap-3">
                         <div class="relative w-full h-32 bg-gray-200 rounded-lg overflow-hidden border border-gray-300 group cursor-pointer">
                            <img id="setting-chat-bg-preview" class="w-full h-full object-cover hidden">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-400 font-medium text-xs bg-gray-100/50 group-hover:bg-gray-100/30 transition">
                                <span id="setting-chat-bg-placeholder">点击上传壁纸</span>
                            </div>
                            <input type="file" id="setting-chat-bg-upload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onchange="ChatSettings.updateChatWallpaper(this)">
                        </div>
                        <button onclick="ChatSettings.clearChatWallpaper()" class="text-red-500 text-xs font-bold text-right">恢复默认</button>
                    </div>
                </div>

                <!-- Custom CSS & UI Settings -->
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer" onclick="document.getElementById('css-settings-content').classList.toggle('hidden'); document.getElementById('css-arrow').classList.toggle('rotate-90')">
                        <span class="text-sm font-bold text-gray-700">界面样式 (CSS)</span>
                        <i id="css-arrow" class="fa-solid fa-chevron-right text-gray-300 text-xs transition-transform duration-200"></i>
                    </div>
                    <div id="css-settings-content" class="hidden p-4 bg-gray-50 space-y-4">
                        
                        <!-- Sliders -->
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-500">气泡大小</span>
                                    <span id="val-bubble-size" class="text-xs text-gray-400 font-mono">1.0</span>
                                </div>
                                <input type="range" id="setting-css-bubble" min="0.8" max="1.5" step="0.05" value="1.0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="CssManager.updateCssVar('bubble', this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-500">字体大小</span>
                                    <span id="val-font-size" class="text-xs text-gray-400 font-mono">16px</span>
                                </div>
                                <input type="range" id="setting-css-font" min="12" max="24" step="1" value="16" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="CssManager.updateCssVar('font', this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-500">头像大小</span>
                                    <span id="val-avatar-size" class="text-xs text-gray-400 font-mono">40px</span>
                                </div>
                                <input type="range" id="setting-css-avatar" min="30" max="60" step="2" value="40" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="CssManager.updateCssVar('avatar', this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-500">底栏图标大小</span>
                                    <span id="val-toolbar-icon" class="text-xs text-gray-400 font-mono">20px</span>
                                </div>
                                <input type="range" id="setting-css-toolbar" min="16" max="32" step="2" value="20" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="CssManager.updateCssVar('toolbar', this.value)">
                            </div>
                        </div>

                        <!-- CSS Editor -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-gray-500 uppercase">自定义 CSS</span>
                                <div class="flex gap-2">
                                    <button onclick="CssManager.openPresetModal()" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded font-bold">选择预设</button>
                                    <button onclick="CssManager.saveCssPreset()" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">保存预设</button>
                                </div>
                            </div>
                            <textarea id="custom-css-input" rows="6" class="w-full bg-gray-800 text-green-400 font-mono text-[10px] p-2 rounded-lg resize-none focus:outline-none" placeholder="/* 在此输入 CSS 代码 */&#10;.bubble { background: pink; }" oninput="CssManager.applyCustomCss(this.value)"></textarea>
                        </div>

                    </div>
                </div>

                <!-- Emoji Pack Binding - 可折叠，支持多选 -->
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer" onclick="document.getElementById('emoji-binding-content').classList.toggle('hidden'); document.getElementById('emoji-arrow').classList.toggle('rotate-90')">
                        <span class="text-sm font-bold text-gray-700">表情包绑定</span>
                        <i id="emoji-arrow" class="fa-solid fa-chevron-right text-gray-300 text-xs transition-transform duration-200"></i>
                    </div>
                    <div id="emoji-binding-content" class="hidden p-4 bg-gray-50">
                        <!-- 表情包多选列表 -->
                        <div id="emoji-multi-select-container" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- 表情包分组将由JS注入 -->
                        </div>
                        <p class="text-[10px] text-gray-400 mt-3">勾选后，AI 可能会根据对话内容发送该分组中的表情包。支持多选或不选。</p>
                    </div>
                </div>

                 <!-- User Persona Section REMOVED as per requirements -->

                 <!-- Memory System -->
                 <div class="bg-white rounded-xl overflow-hidden shadow-sm p-4 space-y-4">
                    <h3 class="text-sm font-bold text-gray-700">记忆与上下文</h3>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">上下文轮数</span>
                        <input type="number" id="setting-ctx-length" class="w-16 bg-gray-100 rounded p-1 text-center text-xs font-bold" value="20" onchange="ChatSettings.saveMemory()">
                    </div>

                    <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs text-gray-600">自动总结 (Auto Summary)</span>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" id="setting-auto-summary" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="ChatSettings.saveMemory()"/>
                            <label for="setting-auto-summary" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    
                    <div id="summary-options" class="hidden space-y-3 pt-2">
                        <div>
                            <span class="text-[10px] text-gray-400 uppercase font-bold">总结频率 (每 N 轮)</span>
                            <input type="number" id="setting-summary-freq" class="w-full mt-1 bg-gray-100 rounded p-2 text-xs" value="10" onchange="ChatSettings.saveMemory()">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 uppercase font-bold">总结提示词</span>
                            <textarea id="setting-summary-prompt" rows="3" class="w-full mt-1 bg-white border border-gray-300 rounded-lg p-2 text-xs resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请总结以下对话的关键信息..." onchange="ChatSettings.saveSummaryPrompt()"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div class="space-y-3">
                    <button onclick="ChatSettings.clearHistory()" class="w-full py-3 bg-white text-orange-500 font-medium rounded-xl shadow-sm active:bg-orange-50 transition border border-orange-100">
                        <i class="fa-regular fa-trash-can mr-2"></i>删除聊天记录
                    </button>
                    <button onclick="ChatSettings.deleteChar()" class="w-full py-3 bg-white text-red-500 font-bold rounded-xl shadow-sm active:bg-red-50 transition border border-red-100">
                        删除角色
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS APP ==================== -->
        <div id="settings-app" class="absolute inset-0 z-50 flex flex-col hidden overflow-hidden">
            
            <!-- Level 1: Main Settings List -->
            <div id="settings-main" class="flex flex-col h-full w-full">
                <!-- Header -->
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0">
                    <button id="close-settings-btn" class="text-blue-500 text-sm font-medium flex items-center gap-1">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 主屏幕
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">设置</h1>
                    <div class="w-12"></div> <!-- Spacer for centering -->
                </div>

                <!-- List Content -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar pb-8">
                    
                    <div class="settings-section">
                        <div class="settings-list-item" onclick="SettingsManager.openPage('page-api')">
                            <span class="text-sm font-medium"><i class="fa-solid fa-server w-6 text-blue-500"></i> API 配置</span>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div class="settings-list-item" onclick="SettingsManager.openPage('page-display')">
                            <span class="text-sm font-medium"><i class="fa-solid fa-font w-6 text-purple-500"></i> 字体与显示</span>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div class="settings-list-item" onclick="SettingsManager.openPage('page-wallpaper')">
                            <span class="text-sm font-medium"><i class="fa-regular fa-image w-6 text-green-500"></i> 壁纸设置</span>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div class="settings-list-item" onclick="SettingsManager.openPage('page-screen')">
                            <span class="text-sm font-medium"><i class="fa-solid fa-mobile-screen w-6 text-orange-500"></i> 屏幕与框架</span>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                        <div class="settings-list-item" onclick="SettingsManager.openPage('page-backup')">
                            <span class="text-sm font-medium"><i class="fa-solid fa-floppy-disk w-6 text-gray-500"></i> 数据备份</span>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>

                    <div class="text-center mt-8 text-gray-400 text-xs">
                        <p>RuriChat v2.1</p>
                        <p>Created with <i class="fa-solid fa-heart text-red-300"></i> by Code</p>
                    </div>

                </div>
            </div>

            <!-- Level 2: Sub Pages -->
            
            <!-- Page A: API Configuration -->
            <div id="page-api" class="settings-page">
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0 bg-[#f2f2f7] border-b border-[#c6c6c8]">
                    <button class="text-blue-500 text-sm font-medium flex items-center gap-1" onclick="SettingsManager.closePage('page-api')">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 设置
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">API 配置</h1>
                    <div class="w-12"></div>
                </div>
                <div class="p-4 space-y-4 overflow-y-auto">
                    <div class="bg-white rounded-xl overflow-hidden p-4 space-y-3 shadow-sm">
                        <div>
                            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">API Endpoint</label>
                            <input type="text" id="api-endpoint" class="w-full bg-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://api.openai.com/v1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">API Key</label>
                            <input type="password" id="api-key" class="w-full bg-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Model Name</label>
                            <div class="flex gap-2">
                                <input type="text" id="api-model" class="flex-1 bg-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="gpt-3.5-turbo">
                                <button onclick="SettingsManager.fetchModels()" class="bg-blue-100 text-blue-600 px-3 py-2 rounded-lg text-sm font-medium active:bg-blue-200 transition">
                                    <i class="fa-solid fa-cloud-arrow-down"></i>
                                </button>
                            </div>
                            <!-- Model Select (Hidden by default) -->
                            <select id="model-select" class="w-full mt-2 bg-gray-100 rounded-lg p-2 text-sm hidden" onchange="document.getElementById('api-model').value = this.value">
                                <option value="">选择模型...</option>
                            </select>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs text-gray-500 uppercase font-bold">Temperature (温度)</label>
                                <span id="api-temp-val" class="text-xs font-mono text-gray-600 bg-gray-100 px-2 py-0.5 rounded">0.8</span>
                            </div>
                            <input type="range" id="api-temperature" min="0" max="2" step="0.1" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="document.getElementById('api-temp-val').textContent = this.value">
                            <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                                <span>0 (稳定精确)</span>
                                <span>1 (平衡)</span>
                                <span>2 (创意多变)</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="SettingsManager.saveApiPreset()" class="w-full bg-white text-blue-500 font-semibold py-3 rounded-xl shadow-sm active:bg-gray-50 transition">保存为预设</button>
                    <button onclick="SettingsManager.saveApiSettings()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition">应用配置</button>
                    
                    <div id="api-presets-list" class="space-y-2 mt-4">
                        <!-- Presets will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Page B: Display & Text -->
            <div id="page-display" class="settings-page">
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0 bg-[#f2f2f7] border-b border-[#c6c6c8]">
                    <button class="text-blue-500 text-sm font-medium flex items-center gap-1" onclick="SettingsManager.closePage('page-display')">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 设置
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">字体与显示</h1>
                    <div class="w-12"></div>
                </div>
                <div class="p-4 space-y-6 overflow-y-auto flex-1">
                    <!-- Font URL -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <label class="block text-xs text-gray-500 uppercase font-bold mb-2">自定义字体 URL</label>
                        <div class="flex gap-2">
                            <input type="text" id="font-url" class="flex-1 bg-gray-100 rounded-lg p-2 text-sm focus:outline-none" placeholder="https://example.com/font.woff">
                            <button onclick="SettingsManager.applyFont()" class="bg-blue-500 text-white px-4 rounded-lg text-sm font-bold">应用</button>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-[10px] text-gray-400">支持 .ttf 或 .woff 格式的网络字体链接。</p>
                            <button onclick="SettingsManager.saveFontPreset()" class="text-[10px] text-blue-500 font-bold">保存预设</button>
                        </div>
                    </div>

                    <!-- Font Presets -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <label class="block text-xs text-gray-500 uppercase font-bold mb-3">字体预设</label>
                        <div id="font-presets-list" class="space-y-2">
                            <p class="text-gray-400 text-center text-[10px] py-2">暂无字体预设</p>
                        </div>
                    </div>

                    <!-- Font Size Slider -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs text-gray-500 uppercase font-bold">全局字号</label>
                            <span id="font-size-val" class="text-xs font-mono text-gray-600">16px</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs">A</span>
                            <input type="range" id="font-slider" min="12" max="24" value="16" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="SettingsManager.updateFontSize(this.value)">
                            <span class="text-xl">A</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page C: Wallpaper -->
            <div id="page-wallpaper" class="settings-page">
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0 bg-[#f2f2f7] border-b border-[#c6c6c8]">
                    <button class="text-blue-500 text-sm font-medium flex items-center gap-1" onclick="SettingsManager.closePage('page-wallpaper')">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 设置
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">壁纸设置</h1>
                    <div class="w-12"></div>
                </div>
                
                <!-- Tabs -->
                <div class="p-4">
                    <div class="flex bg-gray-200 p-1 rounded-lg mb-4">
                        <button class="flex-1 py-1.5 text-sm font-medium rounded-md bg-white shadow-sm transition" id="tab-net" onclick="SettingsManager.switchTab('net')">网络图片</button>
                        <button class="flex-1 py-1.5 text-sm font-medium rounded-md text-gray-500 transition" id="tab-local" onclick="SettingsManager.switchTab('local')">本地上传</button>
                    </div>

                    <!-- Network Tab -->
                    <div id="content-net" class="space-y-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <label class="block text-xs text-gray-500 uppercase font-bold mb-2">图片链接</label>
                            <div class="flex gap-2">
                                <input type="text" id="wallpaper-url" class="flex-1 bg-gray-100 rounded-lg p-2 text-sm focus:outline-none" placeholder="https://...">
                                <button onclick="SettingsManager.setWallpaperFromUrl()" class="bg-blue-500 text-white px-4 rounded-lg text-sm font-bold">应用</button>
                            </div>
                        </div>
                    </div>

                    <!-- Local Tab -->
                    <div id="content-local" class="hidden space-y-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm flex flex-col items-center justify-center border-2 border-dashed border-gray-200 h-40 relative group cursor-pointer">
                            <input type="file" id="wallpaper-upload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onchange="SettingsManager.handleWallpaperUpload(this)">
                            <i class="fa-solid fa-image text-3xl text-gray-300 group-hover:text-blue-500 transition mb-2"></i>
                            <span class="text-sm text-gray-500 font-medium group-hover:text-blue-500 transition">点击选择图片</span>
                        </div>
                        <p class="text-[10px] text-gray-400 text-center">图片将转换为 Base64 存储在本地，请勿上传过大的图片。</p>
                    </div>

                    <!-- Preview -->
                    <div class="mt-6">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-2 ml-1">当前壁纸预览</p>
                        <div class="w-full h-48 rounded-xl bg-gray-200 overflow-hidden bg-cover bg-center border border-gray-300" id="wallpaper-preview"></div>
                        <button onclick="SettingsManager.clearWallpaper()" class="w-full mt-2 text-red-500 text-sm py-2">清除壁纸 (恢复默认)</button>
                    </div>
                </div>
            </div>

            <!-- Page D: Screen & Frame -->
            <div id="page-screen" class="settings-page">
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0 bg-[#f2f2f7] border-b border-[#c6c6c8]">
                    <button class="text-blue-500 text-sm font-medium flex items-center gap-1" onclick="SettingsManager.closePage('page-screen')">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 设置
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">屏幕与框架</h1>
                    <div class="w-12"></div>
                </div>
                <div class="p-4 space-y-6">
                    
                    <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                        <!-- Notch Toggle -->
                        <div class="flex items-center justify-between p-4 border-b border-gray-100">
                            <span class="text-sm font-medium">显示刘海</span>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle-notch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" onchange="SettingsManager.toggleNotch()"/>
                                <label for="toggle-notch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- Immersive Toggle -->
                        <div class="flex items-center justify-between p-4">
                            <span class="text-sm font-medium">沉浸式全屏 (移除外壳)</span>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle-immersive" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" onchange="SettingsManager.toggleImmersive()"/>
                                <label for="toggle-immersive" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Size -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <label class="block text-xs text-gray-500 uppercase font-bold mb-3">自定义尺寸 (px)</label>
                        <div class="flex gap-4 items-center">
                            <div class="flex-1">
                                <span class="text-xs text-gray-400 mb-1 block">宽度</span>
                                <input type="number" id="screen-width" class="w-full bg-gray-100 rounded-lg p-2 text-sm" value="375" onchange="SettingsManager.updateDimensions()">
                            </div>
                            <span class="text-gray-300 pt-4">×</span>
                            <div class="flex-1">
                                <span class="text-xs text-gray-400 mb-1 block">高度</span>
                                <input type="number" id="screen-height" class="w-full bg-gray-100 rounded-lg p-2 text-sm" value="812" onchange="SettingsManager.updateDimensions()">
                            </div>
                        </div>
                        <button onclick="SettingsManager.resetDimensions()" class="mt-3 text-blue-500 text-xs font-medium">重置默认尺寸</button>
                    </div>

                </div>
            </div>

             <!-- Page E: Backup -->
             <div id="page-backup" class="settings-page">
                <div class="settings-header h-24 px-4 pt-10 flex items-center justify-between shrink-0 bg-[#f2f2f7] border-b border-[#c6c6c8]">
                    <button class="text-blue-500 text-sm font-medium flex items-center gap-1" onclick="SettingsManager.closePage('page-backup')">
                        <i class="fa-solid fa-chevron-left text-xs"></i> 设置
                    </button>
                    <h1 class="font-bold text-lg absolute left-1/2 transform -translate-x-1/2">数据备份</h1>
                    <div class="w-12"></div>
                </div>
                <div class="p-8 flex flex-col gap-4 justify-center h-[calc(100%-3rem)]">
                    
                    <div class="text-center mb-8">
                        <i class="fa-solid fa-cloud-arrow-down text-5xl text-blue-500 mb-4"></i>
                        <h2 class="text-xl font-bold text-gray-800">备份与恢复</h2>
                        <p class="text-sm text-gray-500 mt-2">将您的所有设置、壁纸和数据导出为 JSON 文件，或从文件恢复。</p>
                    </div>

                    <button onclick="SettingsManager.exportData()" class="w-full bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-3">
                        <i class="fa-solid fa-download"></i> 导出数据
                    </button>

                    <label class="w-full bg-white text-gray-800 border border-gray-300 font-bold py-4 rounded-xl shadow-sm active:bg-gray-50 transition flex items-center justify-center gap-3 cursor-pointer">
                        <i class="fa-solid fa-upload text-gray-500"></i> 导入数据
                        <input type="file" class="hidden" accept=".json" onchange="SettingsManager.importData(this)">
                    </label>

                </div>
            </div>

        </div>

        <!-- CSS Preset Modal - 弹出选择预设 -->
        <div id="css-preset-modal" class="absolute inset-0 bg-black/40 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-[85%] max-w-[300px] rounded-2xl shadow-2xl max-h-[60%] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-base">选择CSS预设</h3>
                    <button onclick="CssManager.closePresetModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-3">
                    <div id="css-preset-modal-list" class="space-y-2">
                        <!-- Presets will be injected here -->
                        <span class="text-xs text-gray-400 block text-center py-4">暂无预设</span>
                    </div>
                </div>

                <div class="p-3 border-t border-gray-200 shrink-0">
                    <button onclick="CssManager.clearCurrentCss()" class="w-full bg-gray-100 text-gray-600 font-medium py-2 rounded-xl text-sm active:scale-95 transition">
                        清除当前CSS
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- JS -->
    <script src="api.js"></script>
    <script src="apps.js"></script>
    <script src="settings.js"></script>
    <script src="chatRender.js"></script>
    <script src="chatSettings.js"></script>
    <script src="personaManager.js"></script>
    <script src="cssManager.js"></script>
    <script src="ui.js"></script>
    <script src="main.js"></script>
</body>
</html>
