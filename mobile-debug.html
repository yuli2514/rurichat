<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>移动端调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            font-size: 16px;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>移动端调试工具</h1>
    
    <div class="test-item info">
        <h3>设备信息</h3>
        <p id="device-info">检测中...</p>
    </div>
    
    <div class="test-item">
        <h3>基础功能测试</h3>
        <button onclick="testBasic()">测试基础功能</button>
        <button onclick="testLocalStorage()">测试本地存储</button>
        <button onclick="testFetch()">测试网络请求</button>
    </div>
    
    <div class="test-item">
        <h3>Minimax API 测试</h3>
        <input type="text" id="groupId" placeholder="Group ID" style="width: 100%; margin: 5px 0; padding: 8px;">
        <input type="text" id="apiKey" placeholder="API Key" style="width: 100%; margin: 5px 0; padding: 8px;">
        <button onclick="testMinimaxAPI()">测试 Minimax API</button>
    </div>
    
    <div class="test-item">
        <h3>调试日志</h3>
        <button onclick="clearLog()">清空日志</button>
        <div id="log"></div>
    </div>

    <script>
        // 重写console.log来显示在页面上
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addLog(type, ...args) {
            const time = new Date().toLocaleTimeString();
            const message = args.join(' ');
            logDiv.innerHTML += `<div>[${time}] [${type}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', ...args);
        };
        
        // 显示设备信息
        document.getElementById('device-info').innerHTML = `
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>屏幕尺寸:</strong> ${screen.width}x${screen.height}<br>
            <strong>视口尺寸:</strong> ${window.innerWidth}x${window.innerHeight}<br>
            <strong>是否移动端:</strong> ${/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}<br>
            <strong>支持 fetch:</strong> ${typeof fetch !== 'undefined'}<br>
            <strong>支持 localStorage:</strong> ${typeof localStorage !== 'undefined'}
        `;
        
        function testBasic() {
            console.log('开始基础功能测试');
            try {
                // 测试 DOM 操作
                const testDiv = document.createElement('div');
                testDiv.textContent = '测试';
                console.log('DOM 操作: 正常');
                
                // 测试 JSON
                const testObj = { test: '测试' };
                const jsonStr = JSON.stringify(testObj);
                const parsed = JSON.parse(jsonStr);
                console.log('JSON 操作: 正常');
                
                // 测试 Promise
                Promise.resolve('测试').then(result => {
                    console.log('Promise 支持: 正常');
                });
                
                // 测试 async/await
                (async () => {
                    const result = await Promise.resolve('测试');
                    console.log('async/await 支持: 正常');
                })();
                
                console.log('基础功能测试完成');
            } catch (error) {
                console.error('基础功能测试失败:', error);
            }
        }
        
        function testLocalStorage() {
            console.log('开始本地存储测试');
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                console.log('localStorage 测试: 正常');
            } catch (error) {
                console.error('localStorage 测试失败:', error);
            }
        }
        
        async function testFetch() {
            console.log('开始网络请求测试');
            
            // 测试1: 简单的 GET 请求
            try {
                const response = await fetch('https://httpbin.org/get', {
                    method: 'GET',
                    mode: 'cors'
                });
                console.log('httpbin.org GET 请求状态:', response.status);
            } catch (error) {
                console.error('httpbin.org GET 请求失败:', error.message);
            }
            
            // 测试2: 测试 Minimax 域名连通性
            try {
                const response = await fetch('https://api.minimax.chat/', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                console.log('Minimax 域名连通性: 可访问');
            } catch (error) {
                console.error('Minimax 域名连通性失败:', error.message);
            }
            
            // 测试3: 测试当前页面协议
            console.log('当前页面协议:', window.location.protocol);
            console.log('当前页面域名:', window.location.hostname);
            
            // 测试4: 测试 CORS 预检
            try {
                const response = await fetch('https://api.minimax.chat/v1/text_to_speech', {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                console.log('CORS 预检状态:', response.status);
            } catch (error) {
                console.error('CORS 预检失败:', error.message);
            }
            
            console.log('网络请求测试完成');
        }
        
        async function testMinimaxAPI() {
            const groupId = document.getElementById('groupId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!groupId || !apiKey) {
                console.error('请输入 Group ID 和 API Key');
                return;
            }
            
            console.log('开始 Minimax API 测试');
            
            try {
                const endpoint = `https://api.minimax.chat/v1/text_to_speech?GroupId=${groupId}`;
                const requestBody = {
                    model: 'speech-01',
                    text: '你好，这是测试',
                    voice_id: 'female-shaonv',
                    speed: 1.0,
                    vol: 1.0,
                    pitch: 0
                };
                
                console.log('请求端点:', endpoint);
                console.log('请求体:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('响应状态:', response.status);
                console.log('响应头:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('audio/')) {
                        console.log('收到音频响应');
                        const blob = await response.blob();
                        console.log('音频大小:', blob.size, 'bytes');
                        const audioUrl = URL.createObjectURL(blob);
                        const audio = new Audio(audioUrl);
                        await audio.play();
                        console.log('音频播放成功');
                    } else {
                        const text = await response.text();
                        console.log('响应内容:', text);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API 错误响应:', errorText);
                }
                
            } catch (error) {
                console.error('Minimax API 测试失败:', error);
            }
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        // 捕获未处理的错误
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未处理的 Promise 拒绝:', event.reason);
        });
        
        console.log('移动端调试工具已加载');
    </script>
</body>
</html>